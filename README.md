### Скрипт для извлечения и сохранения SSL-сертификатов для домена из файла `acme.json`

Этот скрипт предназначен для извлечения SSL-сертификата и приватного ключа для указанного домена из файла `acme.json`, используемого в Docker для работы с Traefik и Let's Encrypt. Скрипт конвертирует эти данные, декодируя их из формата Base64, и сохраняет их в файлы в указанной директории. Также реализована система ведения логов с ротацией и хранением логов на протяжении заданного времени.

#### Возможности:
- Извлекает SSL-сертификат и приватный ключ для указанного домена из файла `acme.json`.
- Декодирует сертификат и ключ из формата Base64 и сохраняет их в директории конфигурации.
- Записывает сообщения о ходе выполнения в лог-файл с временной меткой.
- Реализована ротация логов: удаление старых логов, которые старше указанного количества дней.
- Проверяет наличие исходного файла и целевой директории, а также корректность извлечения данных.

#### Параметры:
- **ACME_JSON**: Путь к исходному файлу `acme.json`, содержащему сертификаты.
- **CONF_DIR**: Директория для сохранения сертификата и ключа.
- **DOMAIN**: Домен, для которого извлекаются сертификат и ключ.
- **LOG_DIR**: Директория для хранения логов.
- **LOG_RETENTION_DAYS**: Количество дней для хранения логов (по умолчанию 1 день).
- **LOG_FILE**: Файл для записи логов.

#### Как использовать:
1. Настройте переменные в скрипте, указав путь к файлу `acme.json`, целевую директорию и домен.
2. Запустите скрипт. Он извлечет сертификат и ключ для указанного домена, сохранит их в файлы и установит необходимые права доступа.
3. Скрипт будет вести лог работы в указанной директории и автоматически удалять логи старше указанного времени.

#### Пример:
```bash
./extract_certificate.sh
```

#### Требования:
- Установленный `jq` для работы с JSON.
- Доступ к файлу `acme.json`, который используется Traefik для хранения сертификатов Let's Encrypt.

#### Логи:
- Логи сохраняются в директории, указанной в переменной `LOG_DIR`. Логи будут ротацироваться, и старые логи (старше чем `LOG_RETENTION_DAYS` дней) будут удаляться автоматически.

Пример работы скрипта:
1. **Запуск скрипта:**
   - Проверка наличия исходного файла и целевой директории.
   - Извлечение сертификата и ключа.
   - Декодирование и сохранение в нужные файлы.
   
2. **Ведение журнала:**
   - Запись каждого шага в лог файл с временными метками.
   - Логи ротацируются и удаляются через 1 день или на основе настроек.
#### Пример работы скрипта (продолжение):

3. **Ротация логов:**
   - Логи будут автоматически очищаться, если их срок хранения превышает заданное количество дней. Параметр для ротации задается переменной `LOG_RETENTION_DAYS`.
   - Логи можно просматривать в директории `LOG_DIR`, в файле `script.log`.

#### Пример записи в лог:
- Когда скрипт запускается, в лог будет добавлено следующее сообщение:
  ```
  2025-01-01 12:00:00 - Запуск скрипта для домена kb5snr05.mynotation.ru
  ```
- В случае успешного выполнения скрипта:
  ```
  2025-01-01 12:00:10 - Сертификат успешно декодирован и сохранен в ./adguard/confdir/adguard.crt.
  2025-01-01 12:00:15 - Скрипт успешно завершен. Сертификат и ключ для домена kb5snr05.mynotation.ru сохранены в ./adguard/confdir.
  ```

- В случае ошибок:
  ```
  2025-01-01 12:01:00 - Файл /home/suave/docker/traefik/letsencrypt/acme.json не найден!
  ```

#### Настройки для изменения:
- **Путь к `acme.json`:** Параметр `ACME_JSON` можно изменить в случае, если файл расположится в другом месте.
- **Целевая директория для сертификатов и ключей:** Параметр `CONF_DIR` определяет директорию, куда будут сохранены файлы сертификата и ключа.
- **Период хранения логов:** Параметр `LOG_RETENTION_DAYS` можно настроить в зависимости от ваших потребностей для длительности хранения логов.
  
#### Важные замечания:
1. **Права доступа к файлам:** После записи сертификатов и ключей в целевые файлы скрипт устанавливает права доступа 600 для файлов, чтобы они были доступны только владельцу. Убедитесь, что у вас есть права на запись в указанную директорию.
2. **Зависимости:** Скрипт использует утилиту `jq` для извлечения данных из JSON. Убедитесь, что эта утилита установлена на вашем сервере:
   ```bash
   sudo apt-get install jq  # Для Debian/Ubuntu
   sudo yum install jq      # Для CentOS/RHEL
   ```
3. **Обработка ошибок:** Скрипт тщательно проверяет наличие всех необходимых файлов и директорий. Если на каком-то этапе возникнет ошибка (например, файл не найден или не удастся извлечь сертификат), скрипт немедленно завершит выполнение и сообщит об ошибке в лог.

#### Пример вывода логов:
1. **Лог при успешном выполнении:**
   ```
   2025-01-01 12:00:00 - Запуск скрипта для домена kb5snr05.mynotation.ru
   2025-01-01 12:00:05 - Файл /home/suave/docker/traefik/letsencrypt/acme.json найден.
   2025-01-01 12:00:10 - Сертификат и ключ для домена kb5snr05.mynotation.ru извлечены.
   2025-01-01 12:00:15 - Сертификат успешно декодирован и сохранен в ./adguard/confdir/adguard.crt.
   2025-01-01 12:00:20 - Ключ успешно декодирован и сохранен в ./adguard/confdir/adguard.key.
   2025-01-01 12:00:25 - Установлены права доступа 600 для файлов сертификата и ключа.
   2025-01-01 12:00:30 - Скрипт успешно завершен. Сертификат и ключ для домена kb5snr05.mynotation.ru сохранены в ./adguard/confdir.
   ```

2. **Лог при ошибке:**
   ```
   2025-01-01 12:01:00 - Файл /home/suave/docker/traefik/letsencrypt/acme.json не найден!
   2025-01-01 12:01:05 - Не удалось извлечь сертификат или ключ для домена kb5snr05.mynotation.ru из /home/suave/docker/traefik/letsencrypt/acme.json!
   ```

#### Рекомендации:
- **Использование с Traefik и Let's Encrypt:** Этот скрипт идеально подходит для автоматизации процесса извлечения и обработки сертификатов Let's Encrypt, когда используется Traefik в качестве обратного прокси. Вы можете настроить его для регулярного выполнения через cron или систему CI/CD.
- **Безопасность:** Убедитесь, что файл `acme.json` и директория для сертификатов имеют правильные права доступа, чтобы предотвратить несанкционированный доступ к приватным ключам.
- **Запуск скрипта с использованием crontab**
### Запуск скрипта с использованием `crontab`

Чтобы автоматически запускать ваш скрипт на сервере через определенные интервалы времени, вы можете использовать инструмент планировщика задач `cron`. Для этого вам нужно настроить задачу в файле crontab, который управляет расписанием выполнения команд.

#### Шаги для настройки cron-задачи с использованием `crontab -e`:

1. **Открыть crontab для редактирования:**
   Для редактирования crontab файла, выполните команду:

   ```bash
   crontab -e
   ```

   Эта команда откроет файл crontab в текстовом редакторе (обычно используется `vi` или `nano` в зависимости от настроек системы).

2. **Добавить новую задачу для выполнения скрипта:**
   Чтобы настроить выполнение вашего скрипта с нужной периодичностью, добавьте новую строку в crontab файл. Строки в crontab состоят из следующих частей:

   ```
   * * * * * /путь/к/вашему/скрипту
   │ │ │ │ │
   │ │ │ │ └── День недели (0-7) (0 или 7 — воскресенье)
   │ │ │ └──── Месяц (1-12)
   │ │ └────── День месяца (1-31)
   │ └──────── Час (0-23)
   └────────── Минуты (0-59)
   ```

   Например, если вы хотите запускать скрипт каждый день в полночь (00:00), добавьте следующую строку:

   ```bash
   0 0 * * * /path/to/your/script.sh
   ```

   Здесь:
   - `0 0` — означает, что задача будет выполняться в 00:00 (полночь).
   - `* *` — каждый день месяца и каждый месяц.
   - `/path/to/your/script.sh` — полный путь к вашему скрипту.

3. **Пример cron-задачи для регулярного запуска:**
   Если вы хотите запускать скрипт каждый день в 2:00 утра, добавьте в crontab:

   ```bash
   0 2 * * * /path/to/your/script.sh
   ```

   Если вам нужно запускать его каждый час:

   ```bash
   0 * * * * /path/to/your/script.sh
   ```

   А для выполнения скрипта каждое воскресенье в 3:00:

   ```bash
   0 3 * * 0 /path/to/your/script.sh
   ```

4. **Сохранить изменения в crontab:**
   После добавления нужной строки, сохраните файл и выйдите из редактора:
   - Если вы используете `nano`, нажмите `Ctrl + X`, затем `Y`, чтобы подтвердить сохранение, и `Enter`.
   - Если вы используете `vi`, введите `:wq` и нажмите `Enter`.

5. **Проверка установленных cron задач:**
   После сохранения изменений, вы можете проверить, что задача была успешно добавлена, с помощью команды:
   ```bash
   crontab -l
   ```
   Эта команда выведет список всех запланированных задач.

#### Заключение:
Этот скрипт — полезный инструмент для автоматизации работы с SSL-сертификатами Let's Encrypt в средах с Traefik. Он гарантирует, что сертификаты и ключи будут корректно извлечены, сохранены и обработаны, а также позволяет вам удобно отслеживать процесс через логи и управлять их ротацией.
